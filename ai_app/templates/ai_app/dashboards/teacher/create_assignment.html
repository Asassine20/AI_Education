{% extends 'ai_app/dashboards/teacher/course_base.html' %}

{% block title %}
Create Assignment
{% endblock %}

{% block header %}
Create Assignment
{% endblock %}

{% block extra_css %}
<style>
    body {
        color: #434443;
    }

    .title {
        font-weight: bold;
        margin-bottom: 10px;
    }

    .title input {
        width: 99%;
        height: 30px;
        font-size: 18px;
    }

    .text {
        font-weight: bold;
    }

    .post-button {
        background-color: var(--primary-color);
        border-radius: 4px;
        padding: 8px;
        color: var(--secondary-color);
        border: none;
        margin-top: 10px;
        font-size: 16px;
    }

    .post-button:hover {
        filter: brightness(1.5);
        cursor: pointer;
    }

    /* Customizing Flatpickr to use primary and secondary colors */
    .flatpickr-calendar {
        background-color: var(--secondary-color);
    }

    .flatpickr-months {
        background-color: var(--primary-color);
        color: var(--secondary-color);
    }

    .flatpickr-weekdays, .flatpickr-days, .flatpickr-time, .flatpickr-hour, .flatpickr-minute {
        color: var(--primary-color);
    }

    .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-current-month {
        background-color: var(--primary-color) !important;
        color: var(--secondary-color) !important;
    }

    .flatpickr-day:hover {
        background-color: var(--primary-color);
        color: var(--secondary-color);
    }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}
{{ assignment_form.media }}
<form method="post">
    {% csrf_token %}

    <!-- Show form errors -->
    {% if assignment_form.errors %}
    <ul class="errorlist">
        {% for field in assignment_form %}
        {% if field.errors %}
        <li>{{ field.label }}: {{ field.errors }}</li>
        {% endif %}
        {% endfor %}
        {% if assignment_form.non_field_errors %}
        <li>{{ assignment_form.non_field_errors }}</li>
        {% endif %}
    </ul>
    {% endif %}

    <div class="title">
        <label for="id_title">Title:</label>
        {{ assignment_form.title }}
    </div>

    <div>
        <label for="id_description" class="text">Description:</label>
        {{ assignment_form.description }}
    </div>

    <div>
        <label for="id_start_date">Start Date:</label>
        {{ assignment_form.start_date }}
    </div>

    <div>
        <label for="id_due_date">Due Date:</label>
        {{ assignment_form.due_date }}
    </div>

    <div>
        <label for="id_category">Category:</label>
        {{ assignment_form.category }}
    </div>

    <div>
        <label for="id_points">Points:</label>
        {{ assignment_form.points }}
    </div>

    <hr>

    <h3>Questions</h3>
    {{ question_formset.management_form }}

    {% for form in question_formset %}
    <div class="question">
        <h4>Question {{ forloop.counter }}</h4>

        <!-- Display Question Type Field -->
        <div>
            <label for="{{ form.question_type.id_for_label }}">Question Type:</label>
            {{ form.question_type }}
        </div>

        <!-- Always show the question field -->
        <div>
            <label for="{{ form.question.id_for_label }}">Question:</label>
            {{ form.question }}
        </div>

        <!-- Points Field -->
        <div>
            <label for="{{ form.points.id_for_label }}">Points:</label>
            {{ form.points }}
        </div>

        <!-- Multiple Choice Fields (Displayed for Multiple Choice) -->
        <div id="multiple-choice-{{ forloop.counter }}" class="choice-fields" style="display:none;">
            <h5>Choices</h5>
            <div id="choice-fields-container-{{ forloop.counter }}">
                {% for choice_form in form.choice_formset %}
                <div>
                    <label for="{{ choice_form.choice_text.id_for_label }}">Choice {{ forloop.counter }}:</label>
                    {{ choice_form.choice_text }}
                    <label for="{{ choice_form.is_correct.id_for_label }}">Correct Choice:</label>
                    {{ choice_form.is_correct }}
                </div>
                {% endfor %}
            </div>
            <!-- Button to add more choices -->
            <button type="button" class="add-choice-button" data-form-index="{{ forloop.counter }}">Add More Choices</button>
        </div>

        <!-- Dropdown Fields (Displayed for Dropdown) -->
        <div id="dropdown-{{ forloop.counter }}" class="dropdown-fields" style="display:none;">
            <h5>Dropdown Options:</h5>
            <div id="dropdown-fields-container-{{ forloop.counter }}">
                {% for choice_form in form.choice_formset %}
                <div>
                    <label for="{{ choice_form.choice_text.id_for_label }}">Option {{ forloop.counter }}:</label>
                    {{ choice_form.choice_text }}
                    <label for="{{ choice_form.is_correct.id_for_label }}">Correct Option:</label>
                    {{ choice_form.is_correct }}
                </div>
                {% endfor %}
            </div>
            <!-- Button to add more dropdown options -->
            <button type="button" class="add-dropdown-button" data-form-index="{{ forloop.counter }}">Add More Options</button>
        </div>
    </div>
    <hr>
    {% endfor %}

    <!-- Button to add more questions -->
    <button type="button" id="add-question-button">Add More Questions</button>

    <button class="post-button" type="submit">Post Assignment</button>
</form>

<!-- Empty form template for adding new questions dynamically -->
<div id="empty-question-form" style="display:none;">
    {{ question_formset.empty_form.as_p }}
</div>

<script>
    // Initialize Flatpickr for the date-time fields
    flatpickr('.datetimepicker', {
        enableTime: true,
        dateFormat: "Y-m-d H:i:S",  // Match Django's default DateTimeField format
        time_24hr: false,  // Use 12-hour format with AM/PM
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Functionality to toggle choice/dropdown fields based on question type, but keep the question field always visible
        document.querySelectorAll('.question').forEach(function(questionBlock, index) {
            const questionTypeField = questionBlock.querySelector('select[name$=question_type]');
            const multipleChoiceField = document.getElementById('multiple-choice-' + (index + 1));
            const dropdownField = document.getElementById('dropdown-' + (index + 1));

            function toggleFields() {
                const questionType = questionTypeField.value;
                if (questionType === 'MULTIPLE_CHOICE') {
                    multipleChoiceField.style.display = 'block';
                    dropdownField.style.display = 'none';
                } else if (questionType === 'DROPDOWN') {
                    multipleChoiceField.style.display = 'none';
                    dropdownField.style.display = 'block';
                } else {
                    multipleChoiceField.style.display = 'none';
                    dropdownField.style.display = 'none';
                }
            }

            // Attach event listener to the question type select field and trigger toggle on load
            questionTypeField.addEventListener('change', toggleFields);
            toggleFields();  // Initial toggle based on the default value
        });

        // Functionality for adding more choices dynamically in Multiple Choice and Dropdown
        document.querySelectorAll('.add-choice-button').forEach(function(button) {
            button.addEventListener('click', function() {
                const formIndex = button.dataset.formIndex;
                const container = document.getElementById('choice-fields-container-' + formIndex);

                // Create a new choice input field dynamically
                const newChoice = `
                    <div>
                        <label>Choice: </label>
                        <input type="text" name="choice_text_${formIndex}_new" />
                        <label>Correct Choice:</label>
                        <input type="checkbox" name="is_correct_${formIndex}_new" />
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', newChoice);
            });
        });

        document.querySelectorAll('.add-dropdown-button').forEach(function(button) {
            button.addEventListener('click', function() {
                const formIndex = button.dataset.formIndex;
                const container = document.getElementById('dropdown-fields-container-' + formIndex);

                // Create a new dropdown option input field dynamically
                const newOption = `
                    <div>
                        <label>Option: </label>
                        <input type="text" name="option_text_${formIndex}_new" />
                        <label>Correct Option:</label>
                        <input type="checkbox" name="is_correct_${formIndex}_new" />
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', newOption);
            });
        });
    });

    // Functionality for adding more questions dynamically
    document.getElementById('add-question-button').addEventListener('click', function () {
        const formContainer = document.querySelector('form');
        const emptyFormTemplate = document.getElementById('empty-question-form');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS'); // Hidden input for form count

        // Check if 'empty-question-form' exists before attempting to clone it
        if (emptyFormTemplate && totalForms) {
            const emptyFormHtml = emptyFormTemplate.innerHTML;
            const formCount = parseInt(totalForms.value) || 0; // Safeguard against null values

            // Increment the form count and append the new form
            formContainer.insertAdjacentHTML('beforeend', emptyFormHtml.replace(/__prefix__/g, formCount));
            totalForms.value = formCount + 1;
        } else {
            console.error("The 'empty-question-form' template or 'totalForms' input is missing.");
        }
    });
</script>
{% endblock %}


